Các thay đổi cần chỉnh sửa cho giao diện từ NukeViet 3.4.02 cho NukeViet 3.5

Kiểm tra lại link các trang web, các link để rewite được cần tuân theo các nguyên tắc sau
- Sử dụng nháy đôi ("), trong việc viết mã html.
- Các link để được rewite theo các dạng sau
/index.php?language=[ngôn ngữ]
/index.php?language=[ngôn ngữ]&nv=[Tên module]
/index.php?language=[ngôn ngữ]&nv=[Tên module]&op=[Tên op, các biến khác nên truyền hết vào biến này, cách nhau bởi dấu /]
/index.php?language=[ngôn ngữ]&nv=[Tên module]&op=[Tên op, các biến khác nên truyền hết vào biến này, cách nhau bởi dấu /].html
- Trong một số trường hợp link không rewite được (Do trong mã html không có dấu nháy đôi), cần gọi hàn xử lý như sau
$link = '/index.php?language=[ngôn ngữ]&nv=[Tên module]'
$link = nv_url_rewrite( $link, true );

1) Thay đổi cronjobs
	Tìm và xóa đoạn sau trong file /themes/my_theme/layout/footer.tpl
	    <div id="run_cronjobs" style="visibility: hidden; display: none;">
	        <img alt="" title="" src="{THEME_IMG_CRONJOBS}" width="1" height="1" />
	    </div>
	    
   	Tìm và xóa đoạn sau trong file /themes/my_theme/theme.php
    	$xtpl->assign( 'THEME_IMG_CRONJOBS', NV_BASE_SITEURL . "index.php?second=cronjobs&amp;p=" . nv_genpass() );


2) Thay đổi bộ gõ mudim
	Tìm và xóa đoạn sau trong file /themes/my_theme/theme.php (giao diện site)
	if( NV_LANG_INTERFACE == 'vi' )
	{
		$theme_footer_js .= "<script type=\"text/javascript\" src=\"" . NV_BASE_SITEURL . "js/mudim.js\"></script>";
	}
	
	Tìm và xóa đoạn sau trong file /themes/admin_my_theme/theme.php (giao diện admin)
	if( NV_LANG_INTERFACE == 'vi' and NV_LANG_DATA == 'vi' )
	{
		$xtpl->parse( 'main.nv_if_mudim' );
	}
	
	Tìm và xóa đoạn sau trong file /themes/admin_my_theme/system/footer.tpl
	<!-- BEGIN: nv_if_mudim -->
	<script type="text/javascript" src="{NV_BASE_SITEURL}js/mudim.js"></script>
	<!-- END: nv_if_mudim -->
	(Xóa tất cả các chỗ có gắn js/mudim.js ngoại trừ function nv_change_buffer và /install/tpl/step6.tpl)

3) Xóa getloadavg.php, bởi nó ít tác dụng mà khi bật lên làm chậm site
$db->sql_query( "DELETE FROM `" . NV_CONFIG_GLOBALTABLE . "` WHERE `lang` = 'sys' AND `module` = 'global' AND `config_name` = 'getloadavg'" );

4) Thay đổi giao diện admin
Tìm và sửa đoạn sau trong file /themes/admin_my_theme/system/main.tpl
{COUNT_QUERY_STRS}/{NV_TOTAL_TIME}
Sửa thành
[COUNT_SHOW_QUERIES]

Tìm và xóa đoạn sau trong file /themes/admin_my_theme/theme.php (giao diện admin)

	$end_time = array_sum( explode( " ", microtime() ) );

	$xtpl->assign( 'NV_TOTAL_TIME', substr( ( $end_time - NV_START_TIME + $db->time ), 0, 5 ) );

	if( defined( "NV_IS_SPADMIN" ) )
	{
		$xtpl->assign( 'NV_SHOW_QUERIES', $lang_global['show_queries'] );
	}

	$xtpl->assign( 'NV_DB_NUM_QUERIES', $lang_global['db_num_queries'] );
	$xtpl->assign( 'COUNT_QUERY_STRS', sizeof( $db->query_strs ) );
	$xtpl->assign( 'NV_COPYRIGHT', sprintf( $lang_global['copyright'], $global_config['site_name'] ) );

Tìm dòng sau trong file file /themes/admin_my_theme/theme.php (giao diện admin)
		foreach( $db->query_strs as $key => $field )
Thêm lên trên nó đoạn sau
		$xtpl->assign( 'NV_SHOW_QUERIES', $lang_global['show_queries'] );
		$xtpl->assign( 'NV_DB_NUM_QUERIES', $lang_global['db_num_queries'] );

5) Xóa chức năng hiển thị các thông tin cập nhật từ google code

6) Thêm chức năng Ping bài viết qua RPC
- Chức năng này chỉ hoạt động nếu máy chủ support cURL cho php
- Vào menu Dịch vụ PING để chọn các dịch vụ, sau đó lưu lại cấu hình đó.
- Khi thêm hoặc sửa bài viết, nếu bài viết ở chế độ kích hoạt, hệ thống sẽ chuyển đến trang Dịch vụ PING và ping tự động bài viết.
- Để bổ sung proxies hãy sửa file modules/news/proxies.php, theo hướng dẫn trong file đó. 

7) Thay thế jquery.validate
Tìm tất cả các chỗ có jquery.validate để thay thế
Nếu mã html trước khi thay thế là 
<script type="text/javascript" src="/js/jquery/jquery.validate.js"></script>
Cần sửa lại thành
<script type="text/javascript" src="/js/jquery/jquery.validate.min.js"></script>
<script type="text/javascript" src="/js/language/jquery.validator-vi.js"></script>

Trong đó vi: Là ngôn ngữ đang sử dụng của site

7) Tùy biến trường dữ liệu thành viên

CREATE TABLE IF NOT EXISTS `nv3_users_field` (
  `fid` int(11) NOT NULL AUTO_INCREMENT,
  `field` varchar(25) NOT NULL,
  `weight` int(10) unsigned NOT NULL DEFAULT '1',
  `field_type` enum('textbox','textarea','editor','select','radio','checkbox','multiselect') NOT NULL DEFAULT 'textbox',
  `field_choices` mediumtext NOT NULL,
  `match_type` enum('none','alphanumeric','email','url','regex','callback') NOT NULL DEFAULT 'none',
  `match_regex` varchar(250) NOT NULL DEFAULT '',
  `func_callback` varchar(75) NOT NULL DEFAULT '',
  `min_length` bigint(20) unsigned NOT NULL DEFAULT '0',
  `max_length` bigint(20) unsigned NOT NULL DEFAULT '0',
  `required` tinyint(3) unsigned NOT NULL DEFAULT '0',
  `show_register` tinyint(3) unsigned NOT NULL DEFAULT '0',
  `user_editable` enum('yes','once','never') NOT NULL DEFAULT 'yes',
  `show_profile` tinyint(4) NOT NULL DEFAULT '1',
  `class` varchar(50) NOT NULL,
  `language` text NOT NULL,
  `default_value` varchar(255) NOT NULL DEFAULT '',  
  PRIMARY KEY (`fid`),
  UNIQUE KEY `field` (`field`)
) ENGINE=MyISAM;

INSERT INTO `nv3_users_field` (`fid`, `field`, `weight`, `field_type`, `field_choices`, `match_type`, `match_regex`, `func_callback`, `max_length`, `required`, `show_register`, `user_editable`, `show_profile`, `class`, `language`) VALUES
(1, 'website', 1, 'textbox', '', 'callback', '', 'nv_is_url', 255, 0, 0, 'yes', 1, '', 'a:1:{s:2:"vi";a:2:{i:0;s:7:"Website";i:1;s:0:"";}}'),
(2, 'location', 2, 'textbox', '', 'none', '', '', 255, 0, 0, 'yes', 1, '', 'a:1:{s:2:"vi";a:2:{i:0;s:12:"Địa chỉ";i:1;s:0:"";}}'),
(3, 'yim', 3, 'textbox', '', 'none', '', '', 40, 0, 0, 'yes', 1, '', 'a:1:{s:2:"vi";a:2:{i:0;s:18:"Tài khoản Yahoo";i:1;s:0:"";}}'),
(4, 'telephone', 4, 'textbox', '', 'regex', '^[a-zA-Z0-9-_.,]{3,20}$', '', 100, 0, 0, 'yes', 1, '', 'a:1:{s:2:"vi";a:2:{i:0;s:15:"Điện thoại";i:1;s:0:"";}}'),
(5, 'fax', 5, 'textbox', '', 'regex', '^[a-zA-Z0-9-_.,]{3,20}$', '', 100, 0, 0, 'yes', 1, '', 'a:1:{s:2:"vi";a:2:{i:0;s:3:"Fax";i:1;s:0:"";}}'),
(6, 'mobile', 6, 'textbox', '', 'regex', '^[a-zA-Z0-9-_.,]{3,20}$', '', 100, 0, 0, 'yes', 1, '', 'a:1:{s:2:"vi";a:2:{i:0;s:10:"Di động";i:1;s:0:"";}}');


CREATE TABLE IF NOT EXISTS `nv3_users_info` (
  `userid` mediumint(8) unsigned NOT NULL,
  `website` varchar(100) NOT NULL DEFAULT '',
  `location` varchar(100) NOT NULL DEFAULT '',
  `yim` varchar(100) NOT NULL DEFAULT '',
  `telephone` varchar(100) NOT NULL DEFAULT '',
  `fax` varchar(100) NOT NULL DEFAULT '',
  `mobile` varchar(100) NOT NULL DEFAULT '',
  PRIMARY KEY (`userid`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO  `nv3_users_info` SELECT `userid`, `website`, `location`, `yim`, `telephone`, `fax`, `mobile` FROM `nv3_users`

ALTER TABLE `nv3_users`
  DROP `website`,
  DROP `location`,
  DROP `yim`,
  DROP `telephone`,
  DROP `fax`,
  DROP `mobile`; 

7) Cấu hình đăng ký thành viên

REPLACE INTO `nv3_config` (`lang`, `module`, `config_name`, `config_value`) VALUES
('sys', 'global', 'cookie_httponly', '1'),
('sys', 'global', 'admin_check_pass_time', '1800'),
('sys', 'global', 'adminrelogin_max', '0'),
('sys', 'global', 'cookie_secure', '1'),
('sys', 'global', 'nv_unick_type', '0'),
('sys', 'global', 'nv_upass_type', '0'),
('sys', 'global', 'is_flood_blocker', '1'),
('sys', 'global', 'max_requests_60', '400'),
('sys', 'global', 'max_requests_300', '1500'),
('sys', 'global', 'nv_display_errors_list', '1'),
('sys', 'global', 'display_errors_list', '1'),
('sys', 'define', 'nv_unickmin', '4'),
('sys', 'define', 'nv_unickmax', '20'),
('sys', 'define', 'nv_upassmin', '5'),
('sys', 'define', 'nv_upassmax', '255'),
('sys', 'define', 'nv_gfx_num', '6'),
('sys', 'define', 'nv_gfx_width', '120'),
('sys', 'define', 'nv_gfx_height', '25'),
('sys', 'define', 'nv_max_width', '1500'),
('sys', 'define', 'nv_max_height', '1500'),
('sys', 'define', 'nv_live_cookie_time', '31104000'),
('sys', 'define', 'nv_live_session_time', '0'),
('sys', 'define', 'dir_forum', '');

8) xóa popcalendar.js (bản nâng cấp không xóa js này, bởi nhiều module khách có thể sử dụng )

9) Thay đổi CSDL module users để phù hợp với chức năng tìm lại mật khẩu
 
ALTER TABLE `nv3_users` CHANGE `passlostkey` `passlostkey` VARCHAR( 50 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL DEFAULT ''
DELETE FROM `nv3_users_config` WHERE `config` = 'registertype';

10) Cập nhật chức năng không phân viết tài khoản chữ hoa và chữ thường.
UPDATE `nv3_users` SET `md5username` = MD5(LOWER(`username`));

11) Quản lý menu ngang trong admin:
- Có thể bổ sung module mới vào menu, (Module đưa lên menu ngan không bắt buộc là module hệ thống)
- Phân quyền mỗi memu nhóm quản trị nào được dùng
- Sắp xếp vị trí hiển thị các module

CREATE TABLE IF NOT EXISTS `nv3_authors_module` (
  `mid` int(11) NOT NULL AUTO_INCREMENT,
  `module` varchar(55) NOT NULL,
  `lang_key` varchar(50) NOT NULL DEFAULT '',
  `weight` int(11) NOT NULL DEFAULT '0',
  `act_1` tinyint(4) NOT NULL DEFAULT '0',
  `act_2` tinyint(4) NOT NULL DEFAULT '1',
  `act_3` tinyint(4) NOT NULL DEFAULT '1',
  `checksum` varchar(32) NOT NULL DEFAULT '',
  PRIMARY KEY (`mid`),
  UNIQUE KEY `module` (`module`)
) ENGINE=MyISAM  DEFAULT CHARSET=utf8 ;

INSERT INTO `nv3_authors_module` (`mid`, `module`, `lang_key`, `weight`, `act_1`, `act_2`, `act_3`, `checksum`) VALUES
(1, 'siteinfo', 'mod_siteinfo', 1, 1, 1, 1, ''),
(2, 'authors', 'mod_authors', 2, 1, 1, 1, ''),
(3, 'settings', 'mod_settings', 3, 1, 1, 0, ''),
(4, 'database', 'mod_database', 4, 1, 0, 0, ''),
(5, 'webtools', 'mod_webtools', 5, 1, 0, 0, ''),
(6, 'language', 'mod_language', 6, 1, 1, 0, ''),
(7, 'modules', 'mod_modules', 7, 1, 1, 0, ''),
(8, 'themes', 'mod_themes', 8, 1, 1, 0, ''),
(9, 'upload', 'mod_upload', 9, 1, 1, 1, '');

$result = $db->sql_query( "SELECT * FROM `" . NV_AUTHORS_GLOBALTABLE . "_module` ORDER BY `weight` ASC" );
while( $row = $db->sql_fetch_assoc( $result ) )
{
	$checksum = md5( $row['module'] . "#" . $row['act_1'] . "#" . $row['act_2'] . "#" . $row['act_3'] . "#" . $global_config['sitekey'] );
	$db->sql_query( "UPDATE `" . NV_AUTHORS_GLOBALTABLE . "_module` SET `checksum` = '" . $checksum . "' WHERE `mid` = " . $row['mid'] );
}

note: fix commit git push -f